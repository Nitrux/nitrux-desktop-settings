#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2024-2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -eu


# -- Functions

download_appimage() {
    local name
    local url
    local temp_dir
    local destination
    local user_agent

    name="$1"
    url="$2"
    temp_dir=$(mktemp -d)
    destination="$temp_dir/$name"

    user_agent="BrightSign/8.2.55.5 (XT1144) Mozilla/5.0 (X11; Linux aarch64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.12.3 Chrome/69.0.3497.128 Safari/537.36"

    axel -a -q -k -U "$user_agent" -n 8 "$url" -o "$destination"
    chmod +x "$destination"

    echo "$destination"
}


# -- Create $HOME/Applications directory if it doesn't exist.

mkdir -p "$HOME/Applications"


# -- Notify start of installation.

notify-send -a "System Message" -i "appimage-cli-manager" "Installing Bauh (AppImage) in the background, please wait..."

appimage_file=$(download_appimage "bauh-0.10.7-x86_64.AppImage" "https://github.com/vinifmor/bauh/releases/download/0.10.7/bauh-0.10.7-x86_64.AppImage")

mv -f -- "$appimage_file" "$HOME/Applications/"


# -- Add flathub.

flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo


# -- Get absolute path for the AppImage.

APPIMAGE_PATH="$HOME/Applications/bauh-0.10.7-x86_64.AppImage"


# -- Create a desktop launcher for Bauh.

DESKTOP_DIR="$HOME/.local/share/applications"
DESKTOP_FILE="$DESKTOP_DIR/Bauh.desktop"

cat >"$DESKTOP_FILE" <<EOF
[Desktop Entry]
Name=Bauh
Comment=Install and remove applications (AppImage, Arch, Flatpak, Snap, Web)
Exec=${APPIMAGE_PATH} %U
TryExec=${APPIMAGE_PATH}
Keywords=bauh;software;repository;package;install;remove;update;apps;applications;appimage;
Terminal=false
Type=Application
GenericName=Software Manager
Categories=Qt;KDE;System;
StartupNotify=true
Icon=appimage-cli-manager
MimeType=application/vnd.appimage;application/x-executable;
EOF

chmod 0644 "$DESKTOP_FILE"

if command -v update-desktop-database >/dev/null 2>&1; then
    update-desktop-database "$DESKTOP_DIR" >/dev/null 2>&1 || true
fi

notify-send -a "System Message" -i "appimage-cli-manager" "Desktop launcher for Bauh has been created successfully. Installation complete."


# -- Clean up the install script if Bauh was installed successfully.

if [ -f "$APPIMAGE_PATH" ]; then
    rm -f "$HOME/.local/bin/install-bauh-appimage"
    rm -f "$HOME/.local/share/applications/install.bauh.desktop"
fi

exit
