#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2024-2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -eu


# -- Add flathub.

flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo


# -- Install Bottles flatpak.

notify-send -a "System Message" -i "com.usebottles.bottles" "Installing Bottles in the background, please wait..."

FPK_APP="com.usebottles.bottles"

flatpak install -y --user $FPK_APP

notify-send -a "System Message" -i "com.usebottles.bottles" "Installation complete."


# -- Install additional runtimes.

notify-send -a "System Message" -i "com.usebottles.bottles" "Installing additional runtimes in the background, please wait..."

SDK_VERSION="$(flatpak info $FPK_APP | grep "Sdk:" | awk -F'/' '{print $3}')"

flatpak install -y --user "runtime/org.freedesktop.Platform.VulkanLayer.MangoHud/x86_64/$SDK_VERSION"
flatpak install -y --user "runtime/org.freedesktop.Platform.VulkanLayer.vkBasalt/x86_64/$SDK_VERSION"


# -- Check if Bottles is installed an delete install script.

if flatpak list --app --columns=application | grep -q "$FPK_APP"; then
    rm -f "$HOME/.local/bin/install-bottles-flatpak"
    rm -f "$HOME/.local/share/applications/install.bottles.desktop"
fi

notify-send -a "System Message" -i "com.usebottles.bottles" "Launching Bottles."

flatpak run $FPK_APP &

exit
