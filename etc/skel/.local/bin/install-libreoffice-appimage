#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2024-2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -eu


# -- Functions

download_appimage() {
    local name
    local url
    local temp_dir
    local destination
    local user_agent

    name="$1"
    url="$2"
    temp_dir=$(mktemp -d)
    destination="$temp_dir/$name"

    user_agent="BrightSign/8.2.55.5 (XT1144) Mozilla/5.0 (X11; Linux aarch64) AppleWebKit/537.36 (KHTML, like Gecko) QtWebEngine/5.12.3 Chrome/69.0.3497.128 Safari/537.36"

    axel -a -q -k -U "$user_agent" -n 8 "$url" -o "$destination"
    chmod +x "$destination"

    echo "$destination"
}


# -- Create $HOME/Applications directory if it doesn't exist.

mkdir -p "$HOME/Applications"


# -- Notify start of installation.

notify-send -a "System Message" -i "libreoffice-startcenter" "Installing LibreOffice (AppImage) in the background, please wait..."

appimage_file=$(download_appimage "LibreOffice-fresh.standard-x86_64.AppImage" "https://appimages.libreitalia.org/LibreOffice-fresh.standard-x86_64.AppImage")

mv -f -- "$appimage_file" "$HOME/Applications/"


# -- Create a desktop launcher for LibreOffice.

DESKTOP_DIR="$HOME/.local/share/applications"
DESKTOP_FILE="$DESKTOP_DIR/libreoffice-appimage.desktop"
APPIMAGE_PATH="$HOME/Applications/LibreOffice-fresh.standard-x86_64.AppImage"

cat >"$DESKTOP_FILE" <<EOF
[Desktop Entry]
Type=Application
Version=1.0
Name=LibreOffice (AppImage)
GenericName=Office Suite
Comment=LibreOffice (AppImage)
Exec=${APPIMAGE_PATH} %U
Icon=libreoffice-startcenter
Terminal=false
Categories=Office;WordProcessor;Spreadsheet;Presentation;
StartupNotify=true
MimeType=application/vnd.oasis.opendocument.text;application/vnd.oasis.opendocument.spreadsheet;application/vnd.oasis.opendocument.presentation;application/msword;application/vnd.ms-excel;application/vnd.ms-powerpoint;application/vnd.openxmlformats-officedocument.wordprocessingml.document;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;application/vnd.openxmlformats-officedocument.presentationml.presentation;
EOF

chmod 0644 "$DESKTOP_FILE"

if command -v update-desktop-database >/dev/null 2>&1; then
    update-desktop-database "$DESKTOP_DIR" >/dev/null 2>&1 || true
fi

notify-send -a "System Message" -i "libreoffice-startcenter" "Desktop launcher for LibreOffice has been created successfully. Installation complete."


# -- Clean up install script if LibreOffice was installed successfully.

if [ -f "$HOME/Applications/LibreOffice-fresh.standard-x86_64.AppImage" ]; then
    rm -f "$HOME/.local/bin/install-libreoffice-appimage"
    rm -f "$HOME/.local/share/applications/install.libreoffice.desktop"
fi

exit
