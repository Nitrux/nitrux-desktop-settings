#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2025-2026 <Nitrux Latinoamericana S.C. <hello@nxos.org>>

names=$(gdbus call --session \
    --dest org.freedesktop.DBus \
    --object-path /org/freedesktop/DBus \
    --method org.freedesktop.DBus.ListNames 2>/dev/null || echo "")

bus=$(printf '%s\n' "$names" | grep -o "org.mpris.MediaPlayer2[^']*" | head -n1)


if [ -z "$bus" ]; then
    case "$1" in
        --title)   echo "No Title" ;;
        --artist)  echo "No Artist" ;;
        --album)   echo "No Album" ;;
        --length)  echo "0:00 / 0:00" ;;
        --status)  echo "â¹ï¸ Stopped" ;;
        --source)  echo "None" ;;
        --summary) echo "No media detected" ;;
        --art)     ;;
        *)         echo "No media playing" ;;
    esac
    exit 0
fi


if [ "$1" = "--status" ]; then
    status_raw=$(gdbus call --session \
        --dest "$bus" \
        --object-path /org/mpris/MediaPlayer2 \
        --method org.freedesktop.DBus.Properties.Get \
        org.mpris.MediaPlayer2.Player PlaybackStatus 2>/dev/null)
    value=$(printf '%s\n' "$status_raw" | sed -n "s/.*'\([^']*\)'.*/\1/p")
    
    case "$value" in
        "Playing") echo "â–¶ï¸ Playing" ;;
        "Paused")  echo "â¸ï¸ Paused"  ;;
        "Stopped") echo "â¹ï¸ Stopped" ;;
        *)         echo "â¹ï¸ $value"  ;;
    esac
    exit 0
fi


meta=$(gdbus call --session \
    --dest "$bus" \
    --object-path /org/mpris/MediaPlayer2 \
    --method org.freedesktop.DBus.Properties.Get \
    org.mpris.MediaPlayer2.Player Metadata 2>/dev/null)

pos_raw=$(gdbus call --session \
    --dest "$bus" \
    --object-path /org/mpris/MediaPlayer2 \
    --method org.freedesktop.DBus.Properties.Get \
    org.mpris.MediaPlayer2.Player Position 2>/dev/null | sed -n "s/.*int64 \([0-9]*\).*/\1/p")

format_time() {
    local usecs=$1
    if [ -n "$usecs" ]; then
        local secs=$((usecs / 1000000))
        local min=$((secs / 60))
        local sec=$((secs % 60))
        printf "%d:%02d" "$min" "$sec"
    else
        echo "0:00"
    fi
}

title=$(printf '%s\n' "$meta" | sed -n "s/.*'xesam:title': <'\([^']*\)'.*/\1/p")
artist=$(printf '%s\n' "$meta" | sed -n "s/.*'xesam:artist': <\['\([^']*\)'.*/\1/p")
album=$(printf '%s\n' "$meta" | sed -n "s/.*'xesam:album': <'\([^']*\)'.*/\1/p")
length_raw=$(printf '%s\n' "$meta" | sed -n "s/.*'mpris:length': <int64 \([0-9]*\).*/\1/p")
arturl=$(printf '%s\n' "$meta" | sed -n "s/.*'mpris:artUrl': <'\([^']*\)'.*/\1/p")
source="${bus#org.mpris.MediaPlayer2.}"


case "$1" in
    --title)
        echo "${title:-No Title}"
        ;;
    --artist)
        echo "${artist:-No Artist}"
        ;;
    --album)
        echo "${album:-No Album}"
        ;;
    --source)
        echo "${source:-None}"
        ;;
    --length)
        current=$(format_time "$pos_raw")
        total=$(format_time "$length_raw")
        echo "${current} / ${total}"
        ;;
    --summary)
        if [ -n "$title" ] && [ -n "$artist" ]; then
            printf "%s â€” %s\n" "$title" "$artist"
        else
            echo "${title:-No media detected}"
        fi
        ;;
    --art)
        out="$2"
        if [ -n "$arturl" ] && [ -n "$out" ]; then
            if printf '%s' "$arturl" | grep -q '^file://'; then
                file=${arturl#file://}
                cp "$file" "$out" 2>/dev/null || true
            elif command -v curl >/dev/null 2>&1; then
                curl -Lfs "$arturl" -o "$out" 2>/dev/null || true
            fi
        fi
        ;;
    *)
        if [ -n "$title" ] && [ -n "$artist" ]; then
            printf "ðŸŽµ %s â€” %s\n" "$title" "$artist"
        else
            echo "ðŸŽµ ${title:-No media playing}"
        fi
        ;;
esac
