#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2024-2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -eu


# -- The script has two flags: -f for full-screen and -s for region selection (via slurp). It saves to ~/Pictures/, copies to the clipboard, and shows a styled notification.

mode=""
while getopts "fsw" opt; do
    case "$opt" in
        f) mode="full";;
        s) mode="select";;
        w) mode="window";;
        *) echo "Usage: $0 [-f | -s | -w]"; exit 2;;
    esac
done

if [ -z "${mode}" ]; then
    echo "Usage: $0 [-f | -s | -w]"
    exit 2
fi

xdg_dirs="${XDG_CONFIG_HOME:-$HOME/.config}/user-dirs.dirs"
if [ -r "$xdg_dirs" ]; then
    # shellcheck source=/dev/null
    . "$xdg_dirs"
fi

outdir="${XDG_PICTURES_DIR:-$HOME/Pictures}"
mkdir -p "$outdir"
outfile="$outdir/screenshot-$(date +'%Y%m%d-%H%M%S').png"

if [ "$mode" = "full" ]; then
    if grim "$outfile"; then
        wl-copy -t image/png < "$outfile"
        notify-send -a "Grimshot" -u normal -i "$outfile" "Screenshot Taken" "Saved to: $outfile\nAlso copied to clipboard."
    else
        notify-send -a "Grimshot" -u critical -i "dialog-error" "Screenshot Failed" "Could not capture full-screen image."
        exit 1
    fi
else
    if [ "$mode" = "window" ]; then
        geom="$(slurp -w || true)"
    else
        geom="$(slurp || true)"
    fi

    if [ -z "${geom}" ]; then
        notify-send -a "Grimshot" -u low -i "dialog-information" "Screenshot Cancelled" "No selection made."
        exit 1
    fi

    if grim -g "$geom" "$outfile"; then
        wl-copy -t image/png < "$outfile"
        notify-send -a "Grimshot" -u normal -i "$outfile" "Screenshot Taken" "Saved to: $outfile\nAlso copied to clipboard."
    else
        notify-send -a "Grimshot" -u critical -i "dialog-error" "Screenshot Failed" "Could not capture selected area."
        exit 1
    fi
fi
